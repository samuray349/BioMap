<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioMap - Biodiversity Mapping</title>
    <link rel="stylesheet" href="css/styles.css">
  
  <!-- FontAwesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
  <link rel="icon" type="image/x-icon" href="./img/biomap-icon.png">
<style>
    /* ============================================================= */
    /*  ESTILOS ESPEC√çFICOS PARA A P√ÅGINA DE LISTAGEM DE ANIMAIS     */
    /* ============================================================= */

.main-content {
    padding: 30px;
    max-width:90%;
    margin: 0 auto;
}

/* Cabe√ßalho da sec√ß√£o de resultados */
.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
}

.results-title {
    font-size: 2rem;
    font-weight: 600;
}

.sort-group {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1rem;
    position: relative;
}

.sort-group label {
    color: var(--text-medium);
    font-weight: bolder;
}

.select-input {
    padding: 8px 30px 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: white;
    font-size: 1rem;
    appearance: none;
}

.sort-group::after {
    content: '\f078';
    font-family: "Font Awesome 6 Free";
    font-weight: 900;
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--accent-color);
    pointer-events: none;
}

/* Grid de cart√µes */
.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(20%, 1fr));
    gap: 24px;
}

/* Cart√£o individual */
.card {
    background: #ffffff;
    border-radius: 12px;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    display: flex;
    flex-direction: column;
}

.card:hover {
    transform: translateY(-6px);
}

.card-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
}

.card-content {
    padding: 18px;
    display: flex;
    flex-direction: column;
    flex-grow: 1;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.card-header h3 {
    font-size: 1.35rem;
    font-weight: 600;
    color: var(--accent-color);
    margin: 0;
    line-height: 1.2;
}

/* Badges de estado de conserva√ß√£o */
.badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
}



/* Fam√≠lia + √≠cone */
.family {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 10px;
    font-size: 0.95rem;
    color: var(--text-medium);
}

.family-icon {
    color: var(--accent-color);
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    font-size: 14px;
}

/* Descri√ß√£o */
.description {
    color: var(--text-medium);
    font-size: 0.94rem;
    line-height: 1.5;
    margin-bottom: 16px;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Bot√£o "Ver detalhes" */
.btn-details {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--accent-color);
    color: white;
    padding: 5px 16px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.95rem;
    transition: background 0.2s ease;
    margin-top: auto;
}

.btn-details:hover {
    background: var(--accent-hover);
}

.btn-details span {
    font-size: 1.1rem;
}

.sidebar-content{
    padding: 0 0 40px 0  ;
    flex-direction: row;
    align-items: flex-start;
}

.filter-section {
    display: flex;
    flex-direction: column;
}

.search-section {
    display: flex;
    flex-direction: column;
}

.search-section .search-wrapper {
    margin-top: calc(1rem * 1.5 + 4px); /* Match label line-height + margin-bottom to align with tag-input-wrapper */
}

.tag-input-wrapper{
    padding: 0px 40px 0px 12px;
    min-height: 50px;
    display: flex;
    align-items: center;
}

.search-section .search-input {
    height: 50px;
}

.order-input{
    position: relative;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
    border: 1px solid #198754;
    border-radius: 8px;
    padding: 8px 40px 8px 12px;
    background-color: #ffffff;
    cursor: text;
    padding: 0px 40px 0px 12px;
    height: 40px;
    font-size: 16px;
    color: #333;
    select{
        background: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNSIgaGVpZ2h0PSIxMCIgdmlld0JveD0iMCAwIDUgMTAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBvbHlnb24gcG9pbnRzPSIxLjQgNC42NyAyLjUgMy4xOCAzLjYgNC42NyAxLjQgNC42NyIgZmlsbD0iIzE5ODc1NCIvPjxwb2x5Z29uIHBvaW50cz0iMy42IDUuMzMgMi41IDYuODIgMS40IDUuMzMgMy42IDUuMzMiIGZpbGw9IiMxOTg3NTQiLz48L3N2Zz4=) no-repeat 100% 50%;
    -moz-appearance: none;
    -webkit-appearance: none;
    appearance: none;
}
}

.search-section{
    width: 62%;
}

.sort-group:after{
    content: none;
}

.filter-section {
    max-width: 30%;
}

.filters-row{
    flex-direction: row-reverse;
    gap: 40px;
}

.filter-label {
    font-size: 1rem;
    font-weight: bolder;
    color: var(--text-medium);
    margin-bottom: 4px;
    display: block;
}

/* Responsividade extra para telas pequenas */
@media (max-width: 768px) {
    .cards-grid {
        grid-template-columns: 1fr;
    }
    
    .results-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .main-content {
        padding: 20px;
    }
}
</style>
</head>
<body>
    <div id="page-loader" class="page-loader">
        <div class="spinner-border text-success" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    <div id="header-placeholder"></div>
    <!-- Main Content -->
    <main class="main-content">
        <!-- Search and Filters Section -->
        <div class="sidebar-content">
            <div class="search-section">
              <div class="search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="search-input" class="search-input" placeholder="Pesquisar">
              </div>
            </div>
    
            <div class="filters-row">
            
              <div class="filter-section">
                <label class="filter-label">Estado de conserva√ß√£o</label>
                <div class="tag-input-wrapper">
                  <input type="text" id="state-input" class="tag-input" placeholder="Selecionar estado de conserva√ß√£o" autocomplete="off">
                  <div class="tag-container" id="state-tags"></div>
                  <i class="fas fa-chevron-down filter-arrow"></i>
                  <div class="dropdown-menu" id="state-dropdown"></div>
                </div>
              </div>

              <div class="filter-section">
                <label class="filter-label">Fam√≠lia</label>
                <div class="tag-input-wrapper">
                  <input type="text" id="family-input" class="tag-input" placeholder="Selecionar fam√≠lia" autocomplete="off">
                  <div class="tag-container" id="family-tags"></div>
                  <i class="fas fa-chevron-down filter-arrow"></i>
                  <div class="dropdown-menu" id="family-dropdown"></div>
                </div>
              </div>
            </div>
          </div>
        <!-- Results Header -->
        <div class="results-header">
            <h2 class="results-title text-primary">Animais encontrados</h2>
            <div class="sort-group">
                <label>Ordenar por:</label>
                  <select class="order-input">
                      <option>Mais visto</option>
                  </select>
            </div>
        </div>
        <!-- Animal Cards Grid -->
        <div class="cards-grid">
            
        </div>
    </main>
    <script src="js/script.js"></script>
    <script>
        // Loader
        window.addEventListener('load', () => {
            const loader = document.getElementById('page-loader');
            setTimeout(() => {
                if (loader) {
                    loader.classList.add('hidden');
                    // Optional: Remove loader from DOM after animation
                    loader.addEventListener('transitionend', () => loader.remove());
                }
            }, 300);
        });
        loadHeader();
        highlightCurrentPage();
      
        // Arrays para as tags de fam√≠lia e estado de conserva√ß√£o
        let animaisFamilyTags = [];
        let animaisStateTags = [];
      
        const cardsGrid = document.querySelector('.cards-grid');
        const searchInput = document.getElementById('search-input');
        
        // Op√ß√µes para os dropdowns
        const familyOptions = [
          "Felidae", "Canidae", "Ursidae", "Mustelidae", 
          "Cervidae", "Suidae", "Leporidae", "Sciuridae",
          "Accipitridae", "Bovidae", "Lacertidae"
        ];
        
        const stateOptions = [
          "N√£o Avaliada","Dados Insuficientes","Pouco Preocupante","Quase Amea√ßada","Vulner√°vel","Em Perigo","Perigo Cr√≠tico","Extinto na Natureza","Extinto"
        ];
      
        // Fun√ß√£o principal para buscar os animais
        async function fetchAnimals() {
          try {
              // Construir a query string
              const params = new URLSearchParams();
              
              if (searchInput.value.trim()) {
                  params.append('search', searchInput.value.trim());
              }
              if (animaisFamilyTags.length > 0) {
                  params.append('families', animaisFamilyTags.join(','));
              }
              if (animaisStateTags.length > 0) {
                  params.append('states', animaisStateTags.join(','));
              }
      
              // Buscar dos animais da API
              const response = await fetch(`/animais?${params.toString()}`);
              const animals = await response.json();
      
              renderAnimals(animals);
      
          } catch (error) {
              console.error("Erro ao buscar animais:", error);
              cardsGrid.innerHTML = '<p>Erro ao carregar dados.</p>';
          }
        }
      
        // Fun√ß√£o para renderizar os animais
        function renderAnimals(animals) {
          cardsGrid.innerHTML = ''; // Limpar os resultados atuais
      
          if (animals.length === 0) {
              cardsGrid.innerHTML = '<p>Nenhum animal encontrado.</p>';
              return;
          }
      
          animals.forEach(animal => {
              // Determinar a classe do badge com base no texto do estado (l√≥gica opcional)
              let badgeClass = 'badge'; 
      
              const card = document.createElement('div');
              card.className = 'card green-shadow';
              
              card.innerHTML = `
                  <img src="${animal.url_imagem}" alt="${animal.nome_comum}" class="card-image" onerror="this.src='img/placeholder.jpg'">
                  <div class="card-content">
                      <div class="card-header">
                          <h3>${animal.nome_comum}</h3>
                          <span class="badge" style="background-color: ${animal.estado_cor || '#ccc'}; color: white;">
                              ${animal.nome_estado}
                          </span>
                      </div>
                      <div class="family">
                          <span class="family-icon"><i class="fa-solid fa-paw"></i></span>
                          <span>${animal.nome_familia}</span>
                      </div>
                      <p class="description">${animal.descricao}</p>
                      <a href="animal_desc.html?id=${animal.animal_id}" class="btn-details">
                          <span>üëÅ</span> Ver detalhes
                      </a>
                  </div>
              `;
              cardsGrid.appendChild(card);
          });
        }
      
        document.addEventListener('DOMContentLoaded', () => {
          
          // Inicializar o listener do input de pesquisa
          if (searchInput) {
              searchInput.addEventListener('input', () => {
                  fetchAnimals();
              });
          }
      
          // Inicializar os inputs de tags
          if (typeof initTagInputWithDropdown === 'function') {

              
              initTagInputWithDropdown("family-input", "family-tags", "family-dropdown", animaisFamilyTags, familyOptions);
              initTagInputWithDropdown("state-input", "state-tags", "state-dropdown", animaisStateTags, stateOptions);
      
              // Adicionar observers para acionar a busca quando as tags mudarem
              const observerConfig = { childList: true };
              const observer = new MutationObserver(fetchAnimals);
              
              const famContainer = document.getElementById('family-tags');
              const stateContainer = document.getElementById('state-tags');
              
              if (famContainer) observer.observe(famContainer, observerConfig);
              if (stateContainer) observer.observe(stateContainer, observerConfig);
          }
      
          // Carregar os animais
          fetchAnimals();
        });
      </script>
</body>
</html>